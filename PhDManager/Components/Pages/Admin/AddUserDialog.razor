@using LdapForNet
@using Microsoft.AspNetCore.Identity
@using PhDManager.Data
@using PhDManager.Services

@rendermode InteractiveServer

@inject UsersService UsersService
@inject IServiceProvider ServiceProvider

<MudDialog>
    <TitleContent>
        <MudText Typo="Typo.h6">Pridaj užívateľov</MudText>
    </TitleContent>
    <DialogContent>
        <MudDataGrid T="LdapEntry" Items="_filtredUsers" MultiSelection="true" SortMode="SortMode.Multiple" SelectedItemsChanged="@SelectedItemsChangedLdap" Elevation="0">
            <ToolBarContent>
                <MudText Typo="Typo.h6" GutterBottom="false">LDAP užívatelia</MudText>
                <MudSpacer />
                <MudTextField @bind-Value="@_search" @bind-Value:after="@FilterUsers" Class="mr-4" Variant="Variant.Outlined" Placeholder="Hľadaj" Adornment="Adornment.Start" AdornmentIcon="@Icons.Material.Filled.Search" IconSize="Size.Medium"></MudTextField>
            </ToolBarContent>
            <Columns>
                <SelectColumn T="LdapEntry" />
                <PropertyColumn Property="@(e => e.DirectoryAttributes["uid"].GetValue<string>())" Title="Použivateľské meno" />
                <PropertyColumn Property="@(e => e.DirectoryAttributes["displayName"].GetValue<string>())" Title="Celé meno" />
                <PropertyColumn Property="@(e => e.DirectoryAttributes["givenName"].GetValue<string>())" Title="Krstné meno" />
                <PropertyColumn Property="@(e => e.DirectoryAttributes["sn"].GetValue<string>())" Title="Priezvisko" />
                <PropertyColumn Property="@(e => e.DirectoryAttributes["mail"].GetValue<string>())" Title="Email" />
            </Columns>
            <PagerContent>
                <MudDataGridPager T="LdapEntry" />
            </PagerContent>
        </MudDataGrid>
    </DialogContent>
    <DialogActions>
        <MudButton Color="Color.Primary" OnClick="@AddUsers">Pridať</MudButton>
        <MudButton Color="Color.Secondary" OnClick="@(() => MudDialog.Cancel())">Zrušiť</MudButton>
    </DialogActions>
</MudDialog>

@code {
    [CascadingParameter]
    private IMudDialogInstance MudDialog { get; set; }

    [Parameter]
    public LdapEntry[] Users { get; set; }

    private LdapEntry[] _filtredUsers;
    private LdapEntry[] _selectedUsers;

    private string _search = "";

    protected override void OnInitialized()
    {
        _filtredUsers = Users;
    }

    private void FilterUsers()
    {
        _filtredUsers = Users.Where(u => u.DirectoryAttributes["uid"].GetValue<string>().ToLower().Contains(_search.ToLower())).ToArray();
    }

    private async Task AddUsers()
    {
        foreach (var entry in _selectedUsers)
        {
            await UsersService.RegisterLdapUserWithoutPasswordAsync(entry);
        }
        MudDialog.Close();
    }

    private void SelectedItemsChangedLdap(IEnumerable<LdapEntry> entries)
    {
        _selectedUsers = entries.ToArray();
    }
}
