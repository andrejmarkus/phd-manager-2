@page "/admin/individual-plans/add"
@page "/admin/individual-plans/edit/{IndividualPlanGuid}"

@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Identity
@using Microsoft.Extensions.Localization
@using PhDManager.Data
@using PhDManager.Locales
@using PhDManager.Models
@using PhDManager.Services
@using PhDManager.Services.IRepositories

@rendermode InteractiveServer

@inject IServiceProvider ServiceProvider
@inject IUnitOfWork UnitOfWork
@inject IStringLocalizer<Resources> Localizer
@inject UserManager<ApplicationUser> UserManager
@inject NavigationManager NavigationManager

@attribute [Authorize(Roles = "Admin")]

<PageTitle>@Localizer["IndividualPlanCreate"]</PageTitle>

<MudText Typo="Typo.h3">@Localizer["IndividualPlanTitle"]</MudText>

<MudForm @ref="_form">
    <MudAutocomplete T="ApplicationUser" Required RequiredError="@Localizer["IndividualPlanStudentError"]" Label="@Localizer["IndividualPlanStudent"]" ToStringFunc="@(s => s is null ? null : s.DisplayName)" SearchFunc="SearchStudents" Variant="Variant.Outlined" @bind-Value="@_selectedStudent" />
    @if (_selectedStudent is not null)
    {
        @if (_selectedStudent.HasInfo)
        {
            <MudDatePicker ShowToolbar="false" Label="@Localizer["Birthdate"]" Variant="Variant.Outlined" @bind-Date="_selectedStudent.Birthdate" ReadOnly />
            <MudField T="string" Label="@Localizer["Address"]" Variant="Variant.Outlined">@_selectedStudent.Address.FullAddress</MudField>
            <MudField T="string" Label="@Localizer["PhoneNumber"]" Variant="Variant.Outlined">@_selectedStudent.PhoneNumber</MudField>
            <MudField T="string" Label="@Localizer["StudyForm"]" Variant="Variant.Outlined">@(_selectedStudent.IsExternal ? Localizer["StudyFormExternal"] : Localizer["StudyFormDaily"])</MudField>
            <MudField T="string" Label="@Localizer["StudyProgram"]" Variant="Variant.Outlined">@_selectedStudent.StudyProgram?.Name</MudField>
            <MudField T="string" Label="@Localizer["StudyField"]" Variant="Variant.Outlined">@_selectedStudent.StudyProgram?.StudyFieldName</MudField>
            <MudDatePicker ShowToolbar="false" Required RequiredError="@Localizer["IndividualPlanStudyStartDateError"]" Label="@Localizer["IndividualPlanStudyStartDate"]" Variant="Variant.Outlined" @bind-Date="_individualPlan.StudyStartDate" />
        } 
        else
        {
            <MudText Color="Color.Error">@Localizer["IndividualPlanError"]</MudText>
        }
    }

    <MudText Typo="Typo.h5">@Localizer["Deadlines"]</MudText>
    <MudStack Row AlignItems="AlignItems.Center">
        <MudText Class="width-half">@Localizer["IndividualPlanDissertationExamDateInfo"]</MudText>
        <MudDatePicker ShowToolbar="false" Required RequiredError="@Localizer["IndividualPlanDissertationExamDateError"]" Label="@Localizer["IndividualPlanDissertationExamDate"]" Variant="Variant.Outlined" @bind-Date="_individualPlan.DissertationExamDate" />
    </MudStack>
    <MudStack Row AlignItems="AlignItems.Center">
        <MudText Class="width-half">@Localizer["IndividualPlanDissertationSubmissionDateInfo"]</MudText>
        <MudDatePicker ShowToolbar="false" Required RequiredError="@Localizer["IndividualPlanDissertationSubmissionDateError"]" Label="@Localizer["IndividualPlanDissertationSubmissionDate"]" Variant="Variant.Outlined" FixDay="1" OpenTo="OpenTo.Month" @bind-Date="_individualPlan.DissertationSubmissionDate" />
    </MudStack>
    <MudStack Row AlignItems="AlignItems.Center">
        <MudText Class="width-half">@Localizer["IndividualPlanStudyEndDateInfo"]</MudText>
        <MudDatePicker ShowToolbar="false" Required RequiredError="@Localizer["IndividualPlanStudyEndDateError"]" Label="@Localizer["IndividualPlanStudyEndDate"]" Variant="Variant.Outlined" @bind-Date="_individualPlan.StudyEndDate" />
    </MudStack>

    <MudText Typo="Typo.h4">@Localizer["StudyPart"]</MudText>
    <MudText Typo="Typo.h5">@Localizer["IndividualPlanSubjectsInfo"]</MudText>
    <MudAutocomplete T="Subject" Required RequiredError="@Localizer["IndividualPlanSubjectError"]" Label="@($"{Localizer["Subject"]} 1")" ToStringFunc="@(s => s is null ? null : s.Name)" SearchFunc="SearchSubjects" Variant="Variant.Outlined" @bind-Value="_selectedSubjects[0]" />
    <MudAutocomplete T="Subject" Required RequiredError="@Localizer["IndividualPlanSubjectError"]" Label="@($"{Localizer["Subject"]} 2")" ToStringFunc="@(s => s is null ? null : s.Name)" SearchFunc="SearchSubjects" Variant="Variant.Outlined" @bind-Value="_selectedSubjects[1]" />
    <MudAutocomplete T="Subject" Required RequiredError="@Localizer["IndividualPlanSubjectError"]" Label="@($"{Localizer["Subject"]} 3")" ToStringFunc="@(s => s is null ? null : s.Name)" SearchFunc="SearchSubjects" Variant="Variant.Outlined" @bind-Value="_selectedSubjects[2]" />
    <MudText Typo="Typo.h5">@Localizer["IndividualPlanAdditionalSubjectsInfo"]</MudText>
    <MudText>To-Do</MudText>
    <MudText Typo="Typo.h5">@Localizer["IndividualPlanThesisInfo"]</MudText>
    <MudAutocomplete T="Thesis" Required RequiredError="@Localizer["IndividualPlanThesisError"]" Label="@Localizer["IndividualPlanThesis"]" ToStringFunc="@(t => t is null ? null : t.Title)" SearchFunc="SearchTheses" Variant="Variant.Outlined" @bind-Value="_selectedThesis" />
    @if (_selectedThesis is not null)
    {
        <MudField T="string" Label="@Localizer["Supervisor"]" Variant="Variant.Outlined">@_selectedThesis.Supervisor.DisplayName</MudField>
    }

    <MudButton class="mt-4" OnClick="HandleIndividualPlan" Variant="Variant.Filled" Color="Color.Primary">@(IndividualPlanGuid is null ? Localizer["Add"] : Localizer["Edit"])</MudButton>
</MudForm>

@code {
    [Parameter]
    public string? IndividualPlanGuid { get; set; }

    private MudForm? _form;
    private IEnumerable<ApplicationUser>? _students;
    private IEnumerable<Thesis>? _theses;
    private IEnumerable<Subject>? _subjects;

    private IndividualPlan _individualPlan = new();
    private ApplicationUser? _selectedStudent;
    private Thesis? _selectedThesis;
    private Subject[] _selectedSubjects = new Subject[3];

    protected override async Task OnInitializedAsync()
    {
        if (IndividualPlanGuid is not null)
        {
            var individualPlan = await UnitOfWork.IndividualPlans.GetByGuidAsync(IndividualPlanGuid);
            if (individualPlan is not null)
            {
                _individualPlan = individualPlan;
                _selectedStudent = _individualPlan.User;
                _selectedThesis = _individualPlan.Thesis;
                _selectedSubjects = _individualPlan.Subjects.ToArray();
            }
        }
        else
        {
            _individualPlan.StudyStartDate = new DateTime(DateTime.Now.Year, 9, 1);
            _individualPlan.DissertationExamDate = new DateTime(DateTime.Now.Year + 1, 9, 6);
            _individualPlan.DissertationSubmissionDate = new DateTime(DateTime.Now.Year + 3, 4, 1);
            _individualPlan.StudyEndDate = new DateTime(DateTime.Now.Year + 3, 8, 31);
        }

        _students = await UserManager.Users.ToAsyncEnumerable().WhereAwait(async u =>
        {
            using var scope = ServiceProvider.CreateScope();
            var userService = scope.ServiceProvider.GetRequiredService<UsersService>();
            var role = await userService.GetUserRoleAsync(u);
            return role == "Študent";
        }).ToArrayAsync();
        _theses = await UnitOfWork.Theses.GetAllAsync();
        _subjects = await UnitOfWork.Subjects.GetAllAsync();
    }

    private Task<IEnumerable<ApplicationUser>?> SearchStudents(string search, CancellationToken token)
    {
        if (string.IsNullOrWhiteSpace(search))
            return Task.FromResult(_students?.Where(s => s.IndividualPlan is null));

        return Task.FromResult(_students?.Where(s => s.IndividualPlan is null).Where(s => s.DisplayName is not null && s.DisplayName.Contains(search, StringComparison.OrdinalIgnoreCase)));
    }

    private Task<IEnumerable<Thesis>> SearchTheses(string search, CancellationToken token)
    {
        if (_theses is null) return Task.FromResult(Enumerable.Empty<Thesis>());

        if (string.IsNullOrWhiteSpace(search))
            return Task.FromResult(_theses.Where(t => t.StudyProgram == _selectedStudent?.StudyProgram));

        return Task.FromResult(_theses.Where(t => t.StudyProgram == _selectedStudent?.StudyProgram).Where(t => t.Title.Contains(search, StringComparison.OrdinalIgnoreCase)));
    }

    private Task<IEnumerable<Subject>> SearchSubjects(string search, CancellationToken token)
    {
        if (_subjects is null) return Task.FromResult(Enumerable.Empty<Subject>());

        if (string.IsNullOrWhiteSpace(search))
            return Task.FromResult(_subjects.Where(t => t.StudyProgram == _selectedStudent?.StudyProgram));

        return Task.FromResult(_subjects.Where(s => s.StudyProgram == _selectedStudent?.StudyProgram).Where(s => s.Name.Contains(search, StringComparison.OrdinalIgnoreCase)));
    }

    private async Task HandleIndividualPlan()
    {
        if (_form is null || _selectedStudent is null || _selectedThesis is null) return;

        if (_form.IsValid)
        {
            _individualPlan.StudyStartDate = _individualPlan.StudyStartDate?.ToUniversalTime();
            _individualPlan.DissertationExamDate = _individualPlan.DissertationExamDate?.ToUniversalTime();
            _individualPlan.DissertationSubmissionDate = _individualPlan.DissertationSubmissionDate?.ToUniversalTime();
            _individualPlan.StudyEndDate = _individualPlan.StudyEndDate?.ToUniversalTime();
            _individualPlan.User = _selectedStudent;
            _individualPlan.Thesis = _selectedThesis;
            _individualPlan.Subjects = _selectedSubjects.ToList();
            if (IndividualPlanGuid is null)
            {
                await UnitOfWork.IndividualPlans.AddAsync(_individualPlan);
            }
            else
            {
                await UnitOfWork.IndividualPlans.UpdateAsync(_individualPlan.Id, _individualPlan);
            }
            await UnitOfWork.CompleteAsync();
            NavigationManager.NavigateTo("/admin/individual-plans");
        }
    }
}
