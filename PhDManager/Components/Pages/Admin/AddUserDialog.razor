@using LdapForNet
@using Microsoft.AspNetCore.Identity
@using Microsoft.Extensions.Localization
@using PhDManager.Data
@using PhDManager.Locales
@using PhDManager.Services

@rendermode InteractiveServer

@inject IServiceProvider ServiceProvider
@inject IStringLocalizer<Resources> Localizer
@inject UsersService UsersService

<MudDialog>
    <TitleContent>
        <MudText Typo="Typo.h6">@Localizer["UsersAdd"]</MudText>
    </TitleContent>
    <DialogContent>
        <MudDataGrid T="LdapEntry" Items="_filtredUsers" MultiSelection="true" SortMode="SortMode.Multiple" SelectedItemsChanged="@SelectedItemsChangedLdap" Elevation="0">
            <ToolBarContent>
                <MudText Typo="Typo.h6" GutterBottom="false">@Localizer["LdapUsers"]</MudText>
                <MudSpacer />
                <MudTextField @bind-Value="@_search" @bind-Value:after="@FilterUsers" Class="mr-4" Variant="Variant.Outlined" Placeholder="@Localizer["Search"]" Adornment="Adornment.Start" AdornmentIcon="@Icons.Material.Filled.Search" IconSize="Size.Medium"></MudTextField>
            </ToolBarContent>
            <Columns>
                <SelectColumn T="LdapEntry" />
                <PropertyColumn Property="@(e => e.DirectoryAttributes["uid"].GetValue<string>())" Title="@Localizer["Username"]" />
                <PropertyColumn Property="@(e => e.DirectoryAttributes["displayName"].GetValue<string>())" Title="@Localizer["FullName"]" />
                <PropertyColumn Property="@(e => e.DirectoryAttributes["givenName"].GetValue<string>())" Title="@Localizer["FirstName"]" />
                <PropertyColumn Property="@(e => e.DirectoryAttributes["sn"].GetValue<string>())" Title="@Localizer["LastName"]" />
                <PropertyColumn Property="@(e => e.DirectoryAttributes["mail"].GetValue<string>())" Title="Email" />
            </Columns>
            <PagerContent>
                <MudDataGridPager T="LdapEntry" />
            </PagerContent>
        </MudDataGrid>
    </DialogContent>
    <DialogActions>
        <MudButton Color="Color.Primary" OnClick="@AddUsers">@Localizer["Add"]</MudButton>
        <MudButton Color="Color.Secondary" OnClick="@(() => MudDialog.Cancel())">@Localizer["Cancel"]</MudButton>
    </DialogActions>
</MudDialog>

@code {
    [CascadingParameter]
    private IMudDialogInstance MudDialog { get; set; } = default!;

    [Parameter]
    public LdapEntry[] Users { get; set; } = [];

    private LdapEntry[] _filtredUsers = [];
    private LdapEntry[] _selectedUsers = [];

    private string _search = "";

    protected override void OnInitialized()
    {
        _filtredUsers = Users;
    }

    private void FilterUsers()
    {
        _filtredUsers = Users.Where(u => u.DirectoryAttributes["uid"].GetValue<string>().ToLower().Contains(_search.ToLower())).ToArray();
    }

    private async Task AddUsers()
    {
        foreach (var entry in _selectedUsers)
        {
            await UsersService.RegisterLdapUserWithoutPasswordAsync(entry);
        }
        MudDialog.Close();
    }

    private void SelectedItemsChangedLdap(IEnumerable<LdapEntry> entries)
    {
        _selectedUsers = entries.ToArray();
    }
}
